{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <div class="card shadow rounded-4 p-4">
    <h2 class="text-center mb-4">{{ track_name }} - Race on {{ race_session.date.strftime('%B %d, %Y at %I:%M %p') }}</h2>

    <div class="text-center mb-4">
      {% if race_session.best_lap == personal_best %}
        <h5>Fastest Lap: <strong>{{ '%.3f' % race_session.best_lap }}s</strong>
          <span class="badge bg-success ms-2">ðŸŽ‰ New Personal Record!</span>
        </h5>
      {% else %}
        <h5>Fastest Lap: <strong>{{ '%.3f' % race_session.best_lap }}s</strong>
          <small class="text-muted">
            (+{{ '%.3f' % (race_session.best_lap - personal_best) }}s from best lap: {{ '%.3f' % personal_best }}s)
          </small>
        </h5>
      {% endif %}
      <p>Average Lap: <strong>{{ '%.3f' % race_session.avg_lap }}s</strong></p>
      <p>Total Laps: {{ race_session.total_laps }}</p>
    </div>

    <canvas id="lapChart" height="120"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const lapTimes = {{ laps | tojson }};
  const ctx = document.getElementById('lapChart').getContext('2d');

  const minLap = Math.min(...lapTimes);
  const maxLap = Math.max(...lapTimes);

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: lapTimes.map((_, i) => `Lap ${i + 1}`),
      datasets: [{
        label: 'Lap Time',
        data: lapTimes,
        borderColor: '#007bff',
        backgroundColor: 'rgba(0,123,255,0.1)',
        tension: 0.3,
        borderWidth: 2,
        pointRadius: 3,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.label}: ${ctx.parsed.y.toFixed(3)}s`
          }
        }
      },
      scales: {
        x: {
          title: {
            display: true,
            text: 'Lap Number'
          },
          ticks: {
            autoSkip: false
          }
        },
        y: {
          title: {
            display: true,
            text: 'Lap Time (s)'
          },
          beginAtZero: false,
          min: minLap - 0.2,
          max: maxLap + 0.2,
          ticks: {
            stepSize: 0.1
          }
        }
      }
    }
  });
</script>
{% endblock %}
