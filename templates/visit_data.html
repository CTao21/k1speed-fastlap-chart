{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <div class="row gx-1 gy-1">
    <div class="col-md-4">
      <div class="main-card text-center chart-card h-100">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2>Visit Data</h2>
          <a href="{{ url_for('results') }}" class="btn btn-primary">Back to Results</a>
        </div>
        <h5 class="mb-1">{{ username }}</h5>
        <p class="mb-1">Total Races: <strong>{{ total_races }}</strong></p>
        {% if racer_since %}<p class="mb-1">Racer Since: {{ racer_since }}</p>{% endif %}
        {% if favourite_track %}<p class="mb-1">Favourite Location: {{ favourite_track }}</p>{% endif %}
        {% if favourite_day %}<p class="mb-0">Favourite Day: {{ favourite_day }}</p>{% endif %}
        <p class="text-dark mb-0 mt-2"><em>⚠️ This page is a work in progress ⚠️</em></p>
      </div>
    </div>
    <div class="col-md-8 mt-2 mt-md-0">
      <div class="main-card chart-card h-100">
        <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
          <label for="rangeFilter" class="form-label me-2">Time Range:</label>
          <select id="rangeFilter" class="form-select form-select-sm d-inline w-auto">
            <option value="all" selected>All Time</option>
            <option value="this_week">This Week</option>
            <option value="this_month">This Month</option>
            <option value="this_year">This Year</option>
          </select>
          <label for="sortBy" class="form-label ms-2 me-2">Sort By:</label>
          <select id="sortBy" class="form-select form-select-sm d-inline w-auto">
            <option value="day">Day</option>
            <option value="week">Week</option>
            <option value="month" selected>Month</option>
            <option value="year">Year</option>
          </select>
        </div>
        <div class="d-flex flex-wrap align-items-center gap-2 mt-2">
          <label for="fromDate" class="form-label me-1">From:</label>
          <input type="date" id="fromDate" class="form-control form-control-sm d-inline w-auto me-2">
          <label for="toDate" class="form-label me-1">To:</label>
          <input type="date" id="toDate" class="form-control form-control-sm d-inline w-auto me-2">
          <button id="applyManualDate" class="btn btn-outline-secondary btn-sm">Apply</button>
          <button id="clearManualDate" class="btn btn-outline-secondary btn-sm">Clear</button>
        </div>
      </div>
    </div>
  <div class="row gx-1 gy-1 mt-2">
    <div class="col-lg-6">
      <div class="main-card chart-card">
        <div class="chart-container-ios">
          <canvas id="visitChart" style="touch-action:none; width:100%; height:400px;"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="main-card chart-card">
        <div class="chart-container-ios">
          <canvas id="pieChart" style="touch-action:none; width:100%; height:300px;"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="main-card chart-card">
        <div class="chart-container-ios">
          <canvas id="cumulativeChart" style="touch-action:none; width:100%; height:400px;"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="main-card chart-card">
        <div class="chart-container-ios">
          <canvas id="dowChart" style="touch-action:none; width:100%; height:400px;"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-12">
      <div class="main-card chart-card">
        <div class="chart-container-ios">
          <canvas id="hourlyChart" style="touch-action:none; width:100%; height:400px;"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.chart-container-ios {
    background-color: #fff;
    padding: 10px;
    border-radius: 8px;
    overflow: hidden;
    -webkit-overflow-scrolling: touch;
    width: 100%;
    touch-action: none;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const trackData = {{ visit_data | tojson }};
    const trackNames = Object.keys(trackData);
    const colors = ['#e74c3c','#3498db','#2ecc71','#9b59b6','#f1c40f','#e67e22','#1abc9c','#34495e'];

    let manualFrom = null;
    let manualTo = null;

    const ctx = document.getElementById('visitChart');
    const pieCtx = document.getElementById('pieChart');
    const cumCtx = document.getElementById('cumulativeChart');
    const dowCtx = document.getElementById('dowChart');
    const hourlyCtx = document.getElementById('hourlyChart');

    const pieLabelPlugin = {
        id: 'pieLabelPlugin',
        afterDraw(chart, args, opts) {
            const { ctx } = chart;
            const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
            chart.getDatasetMeta(0).data.forEach((arc, i) => {
                const angle = (arc.startAngle + arc.endAngle) / 2;
                const r = arc.outerRadius + (opts.offset || 20);
                const x = arc.x + Math.cos(angle) * r;
                const y = arc.y + Math.sin(angle) * r;
                const value = chart.data.datasets[0].data[i];
                const label = chart.data.labels[i];
                const percent = Math.round((value / total) * 100) + '%';
                ctx.save();
                ctx.fillStyle = opts.color || '#000';
                ctx.font = '12px Roboto';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(label + ' ' + percent, x, y);
                ctx.restore();
            });
        }
    };
    Chart.register(pieLabelPlugin);
    
    const chart = new Chart(ctx, {
        type: 'bar',
        data: { labels: [], datasets: [] },
        options: {
            responsive: true,
            plugins: { 
                legend: { 
                    display: true,
                    position: 'bottom',
                    labels: {
                        boxWidth: 20,
                        padding: 20
                    }
                } 
            },
            scales: {
                x: { 
                    stacked: true, 
                    title: { display: true, text: 'Date' } 
                },
                y: { 
                    beginAtZero: true, 
                    stacked: true, 
                    ticks: { stepSize: 1 }, 
                    title: { display: true, text: 'Sessions' } 
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuad'
            }
        }
    });
    
    const pieChart = new Chart(pieCtx, {
        type: 'pie',
        data: { labels: [], datasets: [{ data: [], backgroundColor: colors, borderColor: '#000', borderWidth: 1 }] },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                pieLabelPlugin: { offset: 30, color: '#000' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    const cumChart = new Chart(cumCtx, {
        type: 'line',
        data: { 
            labels: [], 
            datasets: [
                {
                    label: 'Total Sessions', 
                    data: [], 
                    borderColor: '#e67e22',
                    backgroundColor: 'rgba(230, 126, 34, 0.1)',
                    borderWidth: 3,
                    tension: 0.3,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }
            ] 
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true },
                x: {
                    title: {
                        display: true,
                        text: 'Date'
                    }
                }
            },
            plugins: {
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            }
        }
    });
    
    const dowChart = new Chart(dowCtx, {
        type: 'bar',
        data: { 
            labels: ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'], 
            datasets: [
                {
                    label: 'Visits', 
                    data: [], 
                    backgroundColor: '#3498db',
                    borderColor: '#2980b9',
                    borderWidth: 1
                }
            ] 
        },
        options: { 
            responsive: true, 
            plugins: { 
                legend: { display: false } 
            }, 
            scales: { 
                y: { 
                    beginAtZero: true, 
                    ticks: { stepSize: 1 } 
                },
                x: {
                    title: {
                        display: true,
                        text: 'Day of Week'
                    }
                }
            } 
        }
    });
    
    const hourlyChart = new Chart(hourlyCtx, {
        type: 'bar',
        data: {
            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
            datasets: [
                {
                    label: 'Visits by Hour',
                    data: Array(24).fill(0),
                    backgroundColor: '#9b59b6',
                    borderColor: '#8e44ad',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    },
                    title: {
                        display: true,
                        text: 'Visits'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Hour of Day'
                    }
                }
            }
        }
    });

    function getRange(range) {
        const now = new Date();
        let fromDate = null;
        let toDate = null;

        if (range === 'this_month') {
            fromDate = new Date(now.getFullYear(), now.getMonth(), 1);
        } else if (range === 'this_week') {
            const day = now.getDay() || 7;
            fromDate = new Date(now);
            fromDate.setDate(now.getDate() - day + 1);
        } else if (range === 'this_year') {
            fromDate = new Date(now.getFullYear(), 0, 1);
        }

        if (manualFrom) fromDate = manualFrom;
        if (manualTo) toDate = manualTo;
        return { fromDate, toDate };
    }

    function buildDatasets(sortBy, range) {
        const { fromDate, toDate } = getRange(range);
        const trackTotals = {};
        const countsPerKeyPerTrack = {};
        trackNames.forEach(n => { trackTotals[n] = 0; countsPerKeyPerTrack[n] = {}; });
        const sessions = [];
        const hourlyCounts = Array(24).fill(0);

        trackNames.forEach(name => {
            trackData[name].forEach(d => {
                const dt = new Date(d);
                if (fromDate && dt < fromDate) return;
                if (toDate && dt > toDate) return;
                
                // Count for hourly chart
                const hour = dt.getHours();
                hourlyCounts[hour]++;
                
                let key = d;
                if (sortBy === 'month') key = d.slice(0,7);
                else if (sortBy === 'year') key = d.slice(0,4);
                else if (sortBy === 'week') {
                    const dtCopy = new Date(dt);
                    const day = dtCopy.getDay() || 7;
                    dtCopy.setDate(dtCopy.getDate() - day + 1);
                    key = dtCopy.toISOString().slice(0,10);
                }
                countsPerKeyPerTrack[name][key] = (countsPerKeyPerTrack[name][key] || 0) + 1;
                trackTotals[name] += 1;
                sessions.push(dt);
            });
        });

        const keysSet = new Set();
        trackNames.forEach(n => Object.keys(countsPerKeyPerTrack[n]).forEach(k => keysSet.add(k)));
        const labels = Array.from(keysSet).sort();

        const datasets = trackNames.map((name, idx) => ({
            label: name,
            data: labels.map(k => countsPerKeyPerTrack[name][k] || 0),
            backgroundColor: colors[idx % colors.length],
            borderColor: '#000',
            borderWidth: 1,
            stack: 'sessions'
        }));

        const counts = trackNames.map(n => trackTotals[n]);

        // cumulative totals
        const totalsByLabel = {};
        sessions.forEach(dt => {
            let label = dt.toISOString().slice(0,10);
            if (sortBy === 'month') label = label.slice(0,7);
            else if (sortBy === 'year') label = label.slice(0,4);
            else if (sortBy === 'week') {
                const copy = new Date(dt);
                const day = copy.getDay() || 7;
                copy.setDate(copy.getDate() - day + 1);
                label = copy.toISOString().slice(0,10);
            }
            totalsByLabel[label] = (totalsByLabel[label] || 0) + 1;
        });
        const cumulative = [];
        let running = 0;
        labels.forEach(label => {
            running += totalsByLabel[label] || 0;
            cumulative.push(running);
        });

        // visits by day of week
        const dow = [0,0,0,0,0,0,0];
        sessions.forEach(dt => {
            let idx = dt.getDay();
            idx = (idx + 6) % 7; // Monday=0
            dow[idx] += 1;
        });

        return { labels, datasets, counts, cumulative, dow, hourlyCounts };
    }

    function updateChart() {
        const range = document.getElementById('rangeFilter').value;
        const sortBy = document.getElementById('sortBy').value;
        const result = buildDatasets(sortBy, range);
        
        chart.data.labels = result.labels;
        chart.data.datasets = result.datasets;
        chart.update();
        
        pieChart.data.labels = trackNames;
        pieChart.data.datasets[0].data = result.counts;
        pieChart.update();
        
        cumChart.data.labels = result.labels;
        cumChart.data.datasets[0].data = result.cumulative;
        cumChart.update();
        
        dowChart.data.datasets[0].data = result.dow;
        dowChart.update();
        
        hourlyChart.data.datasets[0].data = result.hourlyCounts;
        hourlyChart.update();
    }

    document.getElementById('rangeFilter').addEventListener('change', updateChart);
    document.getElementById('sortBy').addEventListener('change', updateChart);
    document.getElementById('applyManualDate').addEventListener('click', () => {
        const f = document.getElementById('fromDate').value;
        const t = document.getElementById('toDate').value;
        manualFrom = f ? new Date(f) : null;
        manualTo = t ? new Date(t) : null;
        updateChart();
    });
    document.getElementById('clearManualDate').addEventListener('click', () => {
        manualFrom = manualTo = null;
        document.getElementById('fromDate').value = '';
        document.getElementById('toDate').value = '';
        updateChart();
    });

    updateChart();
});
</script>
{% endblock %}